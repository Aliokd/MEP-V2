# schema.gql
# Data Model for The Conservatory
# Using Firebase Data Connect (PostgreSQL under the hood)

# --- ENUMS ---

enum InstrumentType {
  PIANO
  VIOLIN
  CELLO
  GUITAR
  VOCAL
  OTHER
}

enum NoteType {
  ANECDOTE
  THEORY
  SECRET
}

enum ProgressStatus {
  LOCKED
  STARTED
  MASTERED
}

enum ReactionType {
  BRAVO
  ESPRESSIVO
  PRECISION
}

# --- TABLES ---

# The Musician (mapped to Firebase Auth)
type User @table(name: "Users", singular: "user", plural: "users", key: ["id"]) {
  id: String! @default(expr: "auth.uid") # Maps to Firebase Auth UID - explicitly default to auth.uid is good practice
  email: String!
  displayName: String
  photoURL: String
  instrument: InstrumentType
  skillLevel: String
  synesthesiaSettings: String # JSON/String for custom color mappings
  currentStreak: Int! @default(value: 0)
  resonanceScore: Int! @default(value: 0)
}

# The Curriculum Organizers
type Movement @table(name: "Movements", singular: "movement", plural: "movements") {
  id: UUID! @default(expr: "uuidV4()")
  title: String!
  order: Int!
  description: String
}

# The Lesson Nodes (The Constellation)
type Lesson @table(name: "Lessons", singular: "lesson", plural: "lessons") {
  id: UUID! @default(expr: "uuidV4()")
  movementId: UUID!
  movement: Movement!
  title: String!
  videoUrl: String!
  midiDataUrl: String
  durationSeconds: Int!
  order: Int!
}

# The Graph Logic: Prerequisites (Self-referencing Many-to-Many)
type LessonPrerequisite @table(name: "LessonPrerequisites", key: ["lesson", "prerequisite"]) {
  lessonId: UUID!
  lesson: Lesson!
  prerequisiteId: UUID!
  prerequisite: Lesson!
}

# Maestro's Notes (Linked to specific timestamps in lessons)
type MaestroNote @table(name: "MaestroNotes", singular: "maestroNote", plural: "maestroNotes") {
  id: UUID! @default(expr: "uuidV4()")
  lessonId: UUID!
  lesson: Lesson!
  timestampSeconds: Int!
  content: String!
  noteType: NoteType!
}

# Learning State (Tracking user journey through the constellation)
type UserLessonProgress @table(name: "UserLessonProgress", key: ["user", "lesson"]) {
  userId: String!
  user: User!
  lessonId: UUID!
  lesson: Lesson!
  status: ProgressStatus! @default(value: LOCKED)
  accuracyScore: Int
  lastPlayedAt: Timestamp! @default(expr: "request.time")
}

# Community Uploads (The Recital Hall)
type RepertoireItem @table(name: "RepertoireItems", singular: "repertoireItem", plural: "repertoireItems") {
  id: UUID! @default(expr: "uuidV4()")
  userId: String!
  user: User!
  lessonId: UUID!
  lesson: Lesson!
  performanceVideoUrl: String
  performanceMidiUrl: String
  uploadedAt: Timestamp! @default(expr: "request.time")
}

# Pure Reactions (Elite feedback, no free text)
type RecitalReaction @table(name: "RecitalReactions") {
  id: UUID! @default(expr: "uuidV4()")
  userId: String!
  user: User!
  repertoireItemId: UUID!
  repertoireItem: RepertoireItem!
  reactionType: ReactionType!
}
